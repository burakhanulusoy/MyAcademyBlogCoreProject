@model List<AppRole>

@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/AdminUI/Index.cshtml";
    int count = 0;
}

<div class="main-content-container overflow-hidden">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4 mt-1">
        <h3 class="mb-0">Roller</h3>

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb align-items-center mb-0 lh-1">
                <li class="breadcrumb-item">
                    <a href="index.html" class="d-flex align-items-center text-decoration-none">
                        <i class="ri-home-8-line fs-15 text-primary me-1"></i>
                        <span class="text-body fs-14 hover">Dashboard</span>
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <span>Roller</span>
                </li>
            </ol>
        </nav>
    </div>

    <div class="card bg-white p-20 rounded-10 border border-white mb-4 py-50">

        <div class="card bg-white rounded-10 border border-white mb-4 p-20 mt-4">
            <h4 class="mb-3">Rol Dağılımı Grafiği</h4>

            <div style="position: relative; height: 350px; width: 100%; display: flex; justify-content: center;">
                <canvas id="roleChart"></canvas>
            </div>

            <div class="mt-3 d-flex gap-2 justify-content-center">
                <button id="downloadPng" class="btn btn-primary btn-sm">PNG Olarak İndir</button>
                <button id="downloadPdf" class="btn btn-secondary btn-sm">PDF Olarak İndir</button>
            </div>
        </div>

    </div>

    <div class="card bg-white rounded-10 border border-white mb-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-20">
            <form class="table-src-form position-relative m-0">
                <input type="text" class="form-control w-350" placeholder="Search lead...">
                <div class="src-btn position-absolute top-50 start-0 translate-middle-y bg-transparent p-0 border-0">
                    <span class="material-symbols-outlined">search</span>
                </div>
            </form>

            <a href="/Admin/Role/CreateRole" class="text-primary fs-16 text-decoration-none">Yeni Rol Ekle</a>
        </div>

        <div class="default-table-area mx-minus-1 table-to-do-list">
            <div class="table-responsive">
                <table class="table align-middle w-100">
                    <thead>
                        <tr>
                            <th scope="col" class="fw-medium ps-0">#</th>
                            <th scope="col" class="fw-medium">Rol Adı</th>
                            <th scope="col" class="fw-medium">Sil</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var role in Model)
                        {
                            count++;
                            <tr>
                                <td class="text-body ps-0">@count</td>
                                <td class="text-body">@role.Name</td>
                                <td class="text-body">
                                    <a href="/Admin/Role/DeleteRole/@role.Id" class="btn btn-danger">Sil</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15 p-20">
                <span class="fs-15">Showing 1 to 10 of 50 entries</span>

                <nav class="custom-pagination" aria-label="Page navigation example">
                    <ul class="pagination mb-0 justify-content-center">
                        <li class="page-item">
                            <button class="page-link icon" aria-label="Previous">
                                <i class="material-symbols-outlined">west</i>
                            </button>
                        </li>
                        <li class="page-item">
                            <button class="page-link active">1</button>
                        </li>
                        <li class="page-item">
                            <button class="page-link">2</button>
                        </li>
                        <li class="page-item">
                            <button class="page-link">3</button>
                        </li>
                        <li class="page-item">
                            <button class="page-link icon" aria-label="Next">
                                <i class="material-symbols-outlined">east</i>
                            </button>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const url = this.href;

                    Swal.fire({
                        title: 'Emin misiniz?',
                        text: "Bu işlemi geri alamazsınız!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Evet, sil!',
                        cancelButtonText: 'Hayır'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = url;
                        }
                    });
                });
            });
        });

        const adminCount = @ViewBag.AdminRoleCount;
        const writerCount = @ViewBag.WriterRoleCount;
        const userCount   = @ViewBag.UserRoleCount;

        const ctx = document.getElementById('roleChart');

        const roleChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Admin', 'Writer', 'User'],
                datasets: [{
                    label: 'Kullanıcı Dağılımı',
                    data: [adminCount, writerCount, userCount],
                    backgroundColor: [
                        '#3b82f6',  // Admin
                        '#06b6d4',  // Writer
                        '#10b981'   // User
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // DÜZENLEME: Bu ayar grafiğin div'e tam sığmasını sağlar, devasa olmasını engeller.
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // PNG indir
        document.getElementById("downloadPng").addEventListener("click", () => {
            const link = document.createElement('a');
            link.href = roleChart.toBase64Image();
            link.download = "role_chart.png";
            link.click();
        });

        // PDF indir
        document.getElementById("downloadPdf").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const imgData = roleChart.toBase64Image();
            // PDF içine resmi eklerken boyutları da biraz daha oranlı hale getirdim
            pdf.addImage(imgData, 'PNG', 15, 40, 180, 100);
            pdf.save("role_chart.pdf");
        });

    </script>
}